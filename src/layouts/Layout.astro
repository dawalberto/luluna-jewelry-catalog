---
import "../styles/global.css"
import type { Locale } from "../types/i18n"

interface Props {
  title: string
  description?: string
  lang?: Locale
  canonicalUrl?: string
  image?: string
  robots?: string
  ogType?: "website" | "product" | "article"
  jsonLd?: unknown
}

const {
  title,
  description,
  lang = "es",
  canonicalUrl: canonicalUrlProp,
  image: imageProp,
  robots: robotsProp,
  ogType = "website",
  jsonLd: jsonLdProp,
} = Astro.props

const siteTitle = "Luluna Jewelry"
const artistName = "Dalia López Rubio"
const fullTitle = title ? `${title} | ${siteTitle}` : siteTitle

const defaultDescription =
  "Catálogo de joyas de arcilla polimérica hechas a mano por la artista Dalia López Rubio."

const metaDescription = (description && description.trim().length > 0 ? description : defaultDescription).slice(0, 200)

const baseUrl = import.meta.env.BASE_URL.endsWith("/")
  ? import.meta.env.BASE_URL
  : `${import.meta.env.BASE_URL}/`

const runtimeBase = Astro.site ?? Astro.url

const canonicalUrl = canonicalUrlProp
  ? new URL(canonicalUrlProp, runtimeBase).toString()
  : new URL(Astro.url.pathname, runtimeBase).toString()

const ogImageUrl = imageProp
  ? new URL(imageProp, runtimeBase).toString()
  : new URL(`${baseUrl}favicon_io/android-chrome-512x512.png`, runtimeBase).toString()

const ogLocale = lang === "en" ? "en_US" : "es_ES"
const ogLocaleAlternate = lang === "en" ? "es_ES" : "en_US"

const robots = robotsProp && robotsProp.trim().length > 0 ? robotsProp : "index,follow"

const organizationJsonLd = {
  "@context": "https://schema.org",
  "@type": "Organization",
  name: siteTitle,
  url: new URL(baseUrl, runtimeBase).toString(),
  description: defaultDescription,
  founder: artistName,
  brand: { "@type": "Brand", name: siteTitle },
  logo: new URL(`${baseUrl}favicon_io/android-chrome-512x512.png`, runtimeBase).toString(),
}

const websiteJsonLd = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: siteTitle,
  url: new URL(baseUrl, runtimeBase).toString(),
}

const jsonLdList: unknown[] = [organizationJsonLd, websiteJsonLd]
if (jsonLdProp) {
  if (Array.isArray(jsonLdProp)) jsonLdList.push(...(jsonLdProp as unknown[]))
  else jsonLdList.push(jsonLdProp)
}

const gaMeasurementId = import.meta.env.PUBLIC_GA_MEASUREMENT_ID
const enableGoogleAnalytics = Boolean(gaMeasurementId) && import.meta.env.PROD
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={metaDescription} />
    <meta name="author" content={artistName} />
    <meta name="robots" content={robots} />
    <meta name="generator" content={Astro.generator} />
    <link rel="canonical" href={canonicalUrl} />
    <link rel="icon" href={baseUrl + "favicon_io/favicon.ico"} sizes="any" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href={baseUrl + "favicon_io/favicon-32x32.png"}
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href={baseUrl + "favicon_io/favicon-16x16.png"}
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href={baseUrl + "favicon_io/apple-touch-icon.png"}
    />
    <link rel="manifest" href={baseUrl + "favicon_io/site.webmanifest"} />
    <meta name="theme-color" content="#ffffff" />
    <title>{fullTitle}</title>

    <meta property="og:site_name" content={siteTitle} />
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={metaDescription} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:locale" content={ogLocale} />
    <meta property="og:locale:alternate" content={ogLocaleAlternate} />

    <meta name="twitter:card" content={imageProp ? "summary_large_image" : "summary"} />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={metaDescription} />
    <meta name="twitter:image" content={ogImageUrl} />

    <script type="application/ld+json" is:inline>
      {JSON.stringify(jsonLdList)}
    </script>

    {
      enableGoogleAnalytics && (
        <>
          <script async src={`https://www.googletagmanager.com/gtag/js?id=${gaMeasurementId}`}></script>
          <script is:inline set:html={`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${gaMeasurementId}', { anonymize_ip: true });
          `} />
        </>
      )
    }
  </head>
  <body class="min-h-screen">
    <slot />
  </body>
</html>
