---
import Layout from "../../layouts/Layout.astro"
import { Footer } from "../../components/common"
import HeaderSimple from "../../components/common/HeaderSimple"
import { ProductDetail } from "../../components/catalog"
import { defaultLocale } from "../../i18n/config"
import { ProductService } from "../../services/ProductService"
import { PricingService } from "../../services/PricingService"
import { GlobalDiscountService } from "../../services/GlobalDiscountService"

export async function getStaticPaths() {
  const productService = new ProductService()

  try {
    const res = await productService.getProducts({ publishedOnly: true }, { limit: 5000 })
    return res.data.map((product) => ({
      params: { id: product.id },
    }))
  } catch (error) {
    console.error("Error generating product static paths:", error)
    return []
  }
}

const { id } = Astro.params

if (!id) {
  return Astro.redirect("/catalog")
}

// Fetch product data
const productService = new ProductService()
const pricingService = new PricingService()
const discountService = new GlobalDiscountService()

let product
let pricingConfig
let globalDiscount

try {
  product = await productService.getProductById(id)

  if (!product) {
    return Astro.redirect("/catalog")
  }

  // Only fetch published products for public view
  if (!product.published) {
    return Astro.redirect("/catalog")
  }

  pricingConfig = await pricingService.getPricingConfig()
  globalDiscount = await discountService.getGlobalDiscount()
} catch (error) {
  console.error("Error fetching product:", error)
  return Astro.redirect("/catalog")
}

const locale = defaultLocale
const title = product.title[locale] || product.title.es
const description = product.description[locale] || product.description.es
---

<Layout title={title} description={description} lang={locale}>
  <HeaderSimple client:only="react" />
  <main class="min-h-screen">
    <ProductDetail
      client:load
      product={product}
      pricingConfig={pricingConfig}
      globalDiscount={globalDiscount}
    />
  </main>
  <Footer client:load />
</Layout>
